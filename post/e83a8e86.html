<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>MyBatis启动流程(上) | 小肥龙吃大冰淇淋</title><meta name="keywords" content="源码,MyBatis"><meta name="author" content="小肥龙吃大冰淇淋"><meta name="copyright" content="小肥龙吃大冰淇淋"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="MyBatis 有两方面的 XML 配置，一个是 mybatis-config.xml 配置文件中的整体配置，另一个是 Mapper.xml 配置文件中的 SQL 语句。 在初始化的过程中，MyBatis 会读取 mybatis-config.xml 这个全局配置文件以及所有的 Mapper 映射配置文件，同时还会加载这两个配置文件中指定的类，解析类中的相关注解，最终将解析得到的信息转换成配置对象">
<meta property="og:type" content="article">
<meta property="og:title" content="MyBatis启动流程(上)">
<meta property="og:url" content="https://pengdanhua.github.io/post/e83a8e86.html">
<meta property="og:site_name" content="小肥龙吃大冰淇淋">
<meta property="og:description" content="MyBatis 有两方面的 XML 配置，一个是 mybatis-config.xml 配置文件中的整体配置，另一个是 Mapper.xml 配置文件中的 SQL 语句。 在初始化的过程中，MyBatis 会读取 mybatis-config.xml 这个全局配置文件以及所有的 Mapper 映射配置文件，同时还会加载这两个配置文件中指定的类，解析类中的相关注解，最终将解析得到的信息转换成配置对象">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211108212035.jpg">
<meta property="article:published_time" content="2024-05-30T01:10:36.378Z">
<meta property="article:modified_time" content="2022-11-27T09:16:37.600Z">
<meta property="article:author" content="小肥龙吃大冰淇淋">
<meta property="article:tag" content="源码">
<meta property="article:tag" content="MyBatis">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211108212035.jpg"><link rel="shortcut icon" href="https://lvxueyangboke.oss-cn-beijing.aliyuncs.com/images/20210805191028.png"><link rel="canonical" href="https://pengdanhua.github.io/post/e83a8e86"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'MyBatis启动流程(上)',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-11-27 17:16:37'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/ali_icon.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/mogai.css"><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css"  media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="小肥龙吃大冰淇淋" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="wizard-scene"><div class="wizard-objects"><div class="wizard-square"></div><div class="wizard-circle"></div><div class="wizard-triangle"></div></div><div class="wizard"><div class="wizard-body"></div><div class="wizard-right-arm"><div class="wizard-right-hand"></div></div><div class="wizard-left-arm"><div class="wizard-left-hand"></div></div><div class="wizard-head"><div class="wizard-beard"></div><div class="wizard-face"><div class="wizard-adds"></div></div><div class="wizard-hat"><div class="wizard-hat-of-the-hat"></div><div class="wizard-four-point-star --first"></div><div class="wizard-four-point-star --second"></div><div class="wizard-four-point-star --third"></div></div></div></div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/blog/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">178</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">73</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">40</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-shouyex"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-zuixinwenzhang_huaban"></i><span> 找文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw iconfont icon-fenlei1"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw iconfont icon-biaoqian1"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-shenghuo"></i><span> 生活</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/timeline/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw iconfont icon-lianjie"></i><span> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-gerenzhongxin"></i><span> 关于笔者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211108212035.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">小肥龙吃大冰淇淋</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-shouyex"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-zuixinwenzhang_huaban"></i><span> 找文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw iconfont icon-fenlei1"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw iconfont icon-biaoqian1"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-shenghuo"></i><span> 生活</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/timeline/"><i class="fa-fw iconfont icon-shijianzhou"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw iconfont icon-lianjie"></i><span> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-gerenzhongxin"></i><span> 关于笔者</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">MyBatis启动流程(上)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-05-30T01:10:36.378Z" title="发表于 2024-05-30 09:10:36">2024-05-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-11-27T09:16:37.600Z" title="更新于 2022-11-27 17:16:37">2022-11-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/MyBatis%E6%BA%90%E7%A0%81/">MyBatis源码</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">4.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>16分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="MyBatis启动流程(上)"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>MyBatis 有两方面的 XML 配置，<strong>一个是 mybatis-config.xml 配置文件中的整体配置，另一个是 Mapper.xml 配置文件中的 SQL 语句</strong>。</p>
<p>在初始化的过程中，MyBatis 会读取 mybatis-config.xml 这个全局配置文件以及所有的 Mapper 映射配置文件，同时还会加载这两个配置文件中指定的类，解析类中的相关注解，最终将解析得到的信息转换成配置对象。<strong>完成配置加载之后，MyBatis 就会根据得到的配置对象初始化各个模块</strong>。</p>
<p>MyBatis 在加载配置文件、创建配置对象的时候，会使用到经典设计模式中的<strong>构造者模式</strong>。</p>
<h3 id="构造者模式"><a href="#构造者模式" class="headerlink" title="构造者模式"></a>构造者模式</h3><p><strong>核心的思想</strong></p>
<p>将创建复杂对象的过程与复杂对象本身进行拆分</p>
<p>通俗来讲，构造者模式是<strong>将复杂对象的创建过程分解成了多个简单步骤，在创建复杂对象的时候，只需要了解复杂对象的基本属性即可，而不需要关心复杂对象的内部构造过程</strong>。这样的话，使用方只需要关心这个复杂对象要什么数据，而不再关心内部细节。</p>
<p>构造者模式的类图如下所示：</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202202021058699.png" alt="image-20220202105847637"></p>
<p>从图中，我们可以看到构造者模式的四个核心组件。</p>
<ul>
<li>Product 接口：复杂对象的接口，定义了要创建的目标对象的行为。</li>
<li>ProductImpl 类：Product 接口的实现，它真正要创建的复杂对象，其中实现了我们需要的复杂业务逻辑。</li>
<li>Builder 接口：定义了构造 Product 对象的每一步行为。</li>
<li>BuilderImpl 类：Builder 接口的具体实现，其中具体实现了构造一个 Product 的每一个步骤，例如上图中的 setPart1()、setPart2() 等方法，都是用来构造 ProductImpl 对象的各个部分。在完成整个 Product 对象的构造之后，我们会通过 build() 方法返回这个构造好的 Product 对象。</li>
</ul>
<p>使用构造者模式一般有两个目的。第一个目的是<strong>将使用方与复杂对象的内部细节隔离，从而实现解耦的效果</strong>。使用方提供的所有信息，都是由 Builder 这个“中间商”接收的，然后由 Builder 消化这些信息并构造出一个完整可用的 Product 对象。第二个目的是<strong>简化复杂对象的构造过程</strong>。在很多场景中，复杂对象可能有很多默认属性，这时我们就可以将这些默认属性封装到 Builder 中，这样就可以简化创建复杂对象所需的信息。</p>
<p>通过构建者模式的类图我们还可以看出，<strong>每个 BuilderImpl 实现都是能够独立创建出对应的 ProductImpl 对象</strong>，那么在程序需要扩展的时候，我们只需要添加新的 BuilderImpl 和 ProductImpl，就能实现功能的扩展，这完全符合“开放-封闭原则”。</p>
<h3 id="mybatis-config-xml-解析全流程"><a href="#mybatis-config-xml-解析全流程" class="headerlink" title="mybatis-config.xml 解析全流程"></a>mybatis-config.xml 解析全流程</h3><p><strong>MyBatis 初始化的第一个步骤就是加载和解析 mybatis-config.xml 这个全局配置文件</strong>，入口是 XMLConfigBuilder 这个 Builder 对象，它由 SqlSessionFactoryBuilder.build() 方法创建。XMLConfigBuilder 会解析 mybatis-config.xml 配置文件得到对应的 Configuration 全局配置对象，然后 SqlSessionFactoryBuilder 会根据得到的 Configuration 全局配置对象创建一个 DefaultSqlSessionFactory 对象返回给上层使用。</p>
<p>这里<strong>创建的 XMLConfigBuilder 对象的核心功能就是解析 mybatis-config.xml 配置文件</strong>。XMLConfigBuilder 有一部分能力继承自 BaseBuilder 抽象类，具体继承关系如下图所示：</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202202021104636.png" alt="image-20220202110419600"></p>
<p>BaseBuilder 抽象类扮演了构造者模式中 Builder 接口的角色，下面我们先来看 BaseBuilder 中各个字段的定义。</p>
<ul>
<li>configuration（Configuration 类型）：MyBatis 的初始化过程就是围绕 Configuration 对象展开的，我们可以认为 Configuration 是一个单例对象，MyBatis 初始化解析到的全部配置信息都会记录到 Configuration 对象中。</li>
<li>typeAliasRegistry（TypeAliasRegistry 类型）：别名注册中心。比如，订单系统示例中，我们在 mybatis-config.xml 配置文件中，使用 标签为很多类定义了别名。</li>
<li>typeHandlerRegistry（TypeHandlerRegistry 类型）：TypeHandler 注册中心。除了定义别名之外，我们在 mybatis-config.xml 配置文件中，还可以使用 <code>&lt;typeHandlers&gt;</code> 标签添加自定义 TypeHandler 实现，实现数据库类型与 Java 类型的自定义转换，这些自定义的 TypeHandler 都会记录在这个 TypeHandlerRegistry 对象中。</li>
</ul>
<p>除了关联 Configuration 对象之外，BaseBuilder 还提供了另外两个基本能力：</p>
<ul>
<li><strong>解析别名</strong>，核心逻辑是在 resolveAlias() 方法中实现的，主要依赖于 TypeAliasRegistry 对象；</li>
<li><strong>解析 TypeHandler</strong>，核心逻辑是在 resolveTypeHandler() 方法中实现的，主要依赖于 TypeHandlerRegistry 对象。</li>
</ul>
<p>了解了 BaseBuilder 提供的基础能力之后，我们回到 XMLConfigBuilder 这个 Builder 实现类，看看它是如何解析 mybatis-config.xml 配置文件的。</p>
<p>首先我们来了解一下 XMLConfigBuilder 的核心字段。</p>
<ul>
<li>parsed（boolean 类型）：状态标识字段，记录当前 XMLConfigBuilder 对象是否已经成功解析完 mybatis-config.xml 配置文件。</li>
<li>parser（XPathParser 类型）：XPathParser 对象是一个 XML 解析器，这里的 parser 对象就是用来解析 mybatis-config.xml 配置文件的。</li>
<li>environment（String 类型）： 标签定义的环境名称。</li>
<li>localReflectorFactory（ReflectorFactory 类型）：ReflectorFactory 接口的核心功能是实现对 Reflector 对象的创建和缓存。</li>
</ul>
<p>在 SqlSessionFactoryBuilder.build() 方法中也可以看到，XMLConfigBuilder.parse() 方法触发了 mybatis-config.xml 配置文件的解析，<strong>其中的 parseConfiguration() 方法定义了解析 mybatis-config.xml 配置文件的完整流程</strong>，核心步骤如下：</p>
<ul>
<li>解析 <code>&lt;properties&gt;</code> 标签；</li>
<li>解析 <code>&lt;settings&gt;</code> 标签；</li>
<li>处理日志相关组件；</li>
<li>解析 <code>&lt;typeAliases&gt;</code> 标签；</li>
<li>解析 <code>&lt;plugins&gt;</code> 标签；</li>
<li>解析 <code>&lt;objectFactory&gt;</code> 标签；</li>
<li>解析 <code>&lt;objectWrapperFactory&gt;</code> 标签；</li>
<li>解析 <code>&lt;reflectorFactory&gt;</code> 标签；</li>
<li>解析 <code>&lt;environments&gt;</code> 标签；</li>
<li>解析 <code>&lt;databaseIdProvider&gt;</code> 标签；</li>
<li>解析 <code>&lt;typeHandlers&gt;</code> 标签；</li>
<li>解析 <code>&lt;mappers&gt;</code> 标签。</li>
</ul>
<p>从 parseConfiguration()方法中，我们可以清晰地看到 XMLConfigBuilder 对 mybatis-config.xml 配置文件中各类标签的解析方法，下面我们就逐一介绍这些方法的核心实现。</p>
<h4 id="1-处理-lt-properties-gt-标签"><a href="#1-处理-lt-properties-gt-标签" class="headerlink" title="1. 处理&lt;properties&gt;标签"></a>1. 处理<code>&lt;properties&gt;</code>标签</h4><p>我们可以通过 <code>&lt;properties&gt;</code> 标签定义 KV 信息供 MyBatis 使用，propertiesElement() 方法的核心逻辑就是解析 mybatis-config.xml 配置文件中的 <code>&lt;properties&gt;</code> 标签。</p>
<p>从 <code>&lt;properties&gt;</code> 标签中解析出来的 KV 信息会被记录到一个 Properties 对象（也就是 Configuration 全局配置对象的 variables 字段），在后续解析其他标签的时候，MyBatis 会使用这个 Properties 对象中记录的 KV 信息替换匹配的占位符。</p>
<h4 id="2-处理-lt-settings-gt-标签"><a href="#2-处理-lt-settings-gt-标签" class="headerlink" title="2. 处理&lt;settings&gt;标签"></a>2. 处理<code>&lt;settings&gt;</code>标签</h4><p>MyBatis 中有很多全局性的配置，例如，是否使用二级缓存、是否开启懒加载功能等，这些都是通过 mybatis-config.xml 配置文件中的 <code>&lt;settings&gt;</code> 标签进行配置的。</p>
<p>XMLConfigBuilder.settingsAsProperties() 方法的核心逻辑就是解析 <code>&lt;settings&gt;</code> 标签，并将解析得到的配置信息记录到 Configuration 这个全局配置对象的同名属性中，具体实现如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Properties <span class="title">settingsAsProperties</span><span class="params">(XNode context)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (context == <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Properties();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理&lt;settings&gt;标签的所有子标签，也就是&lt;setting&gt;标签，将其name属性和value属性</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 整理到Properties对象中保存</span></span><br><span class="line"></span><br><span class="line">    Properties props = context.getChildrenAsProperties();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建Configuration对应的MetaClass对象</span></span><br><span class="line"></span><br><span class="line">    MetaClass metaConfig = MetaClass.forClass(Configuration.class, localReflectorFactory);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检测Configuration对象中是否包含每个配置项的setter方法</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Object key : props.keySet()) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!metaConfig.hasSetter(String.valueOf(key))) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">&quot;The setting &quot;</span> + key + <span class="string">&quot; is not known.  Make sure you spelled it correctly (case sensitive).&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> props;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-处理-lt-typeAliases-gt-和-lt-typeHandlers-gt-标签"><a href="#3-处理-lt-typeAliases-gt-和-lt-typeHandlers-gt-标签" class="headerlink" title="3. 处理&lt;typeAliases&gt;和&lt;typeHandlers&gt;标签"></a>3. 处理<code>&lt;typeAliases&gt;</code>和<code>&lt;typeHandlers&gt;</code>标签</h4><p>XMLConfigBuilder 中提供了 typeAliasesElement() 方法和 typeHandlerElement() 方法，分别用来负责处理 <code>&lt;typeAliases&gt;</code> 标签和 <code>&lt;typeHandlers&gt;</code> 标签，解析得到的别名信息和 TypeHandler 信息就会分别记录到 TypeAliasRegistry 和 TypeHandlerRegistry（前面介绍 BaseHandler 的时候，我们已经简单介绍过这两者了）。</p>
<p>下面我们以 typeHandlerElement() 方法为例来分析一下这个过程：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">typeHandlerElement</span><span class="params">(XNode parent)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (XNode child : parent.getChildren()) &#123; <span class="comment">// 处理全部&lt;typeHandler&gt;子标签</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;package&quot;</span>.equals(child.getName())) &#123; </span><br><span class="line"></span><br><span class="line">                <span class="comment">// 如果指定了package属性，则扫描指定包中所有的类，</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 并解析@MappedTypes注解，完成TypeHandler的注册</span></span><br><span class="line"></span><br><span class="line">                String typeHandlerPackage = child.getStringAttribute(<span class="string">&quot;name&quot;</span>);</span><br><span class="line"></span><br><span class="line">                typeHandlerRegistry.register(typeHandlerPackage);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 如果没有指定package属性，则尝试获取javaType、jdbcType、handler三个属性</span></span><br><span class="line"></span><br><span class="line">                String javaTypeName = child.getStringAttribute(<span class="string">&quot;javaType&quot;</span>);</span><br><span class="line"></span><br><span class="line">                String jdbcTypeName = child.getStringAttribute(<span class="string">&quot;jdbcType&quot;</span>);</span><br><span class="line"></span><br><span class="line">                String handlerTypeName = child.getStringAttribute(<span class="string">&quot;handler&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 根据属性确定TypeHandler类型以及它能够处理的数据库类型和Java类型</span></span><br><span class="line"></span><br><span class="line">                Class&lt;?&gt; javaTypeClass = resolveClass(javaTypeName);</span><br><span class="line"></span><br><span class="line">                JdbcType jdbcType = resolveJdbcType(jdbcTypeName);</span><br><span class="line"></span><br><span class="line">                Class&lt;?&gt; typeHandlerClass = resolveClass(handlerTypeName);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 调用TypeHandlerRegistry.register()方法注册TypeHandler</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (javaTypeClass != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (jdbcType == <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">                        typeHandlerRegistry.register(javaTypeClass, typeHandlerClass);</span><br><span class="line"></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                        typeHandlerRegistry.register(javaTypeClass, jdbcType, typeHandlerClass);</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                    typeHandlerRegistry.register(typeHandlerClass);</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-处理-lt-plugins-gt-标签"><a href="#4-处理-lt-plugins-gt-标签" class="headerlink" title="4. 处理&lt;plugins&gt;标签"></a>4. 处理<code>&lt;plugins&gt;</code>标签</h4><p>我们知道 MyBatis 是一个非常易于扩展的持久层框架，而<strong>插件就是 MyBatis 提供的一种重要扩展机制</strong>。</p>
<p>我们可以自定义一个实现了 Interceptor 接口的插件来扩展 MyBatis 的行为，或是拦截 MyBatis 的一些默认行为。插件的工作机制我们会在后面的课时中详细分析，这里我们重点来看 MyBatis 初始化过程中插件配置的加载，也就是 XMLConfigBuilder 中的 pluginElement()方法，该方法的核心就是解析 <code>&lt;plugins&gt;</code> 标签中配置的自定义插件，具体实现如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">pluginElement</span><span class="params">(XNode parent)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 遍历全部的&lt;plugin&gt;子标签</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (XNode child : parent.getChildren()) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取每个&lt;plugin&gt;标签中的interceptor属性</span></span><br><span class="line"></span><br><span class="line">            String interceptor = child.getStringAttribute(<span class="string">&quot;interceptor&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取&lt;plugin&gt;标签下的其他配置信息</span></span><br><span class="line"></span><br><span class="line">            Properties properties = child.getChildrenAsProperties();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 初始化interceptor属性指定的自定义插件</span></span><br><span class="line"></span><br><span class="line">            Interceptor interceptorInstance = (Interceptor) resolveClass(interceptor).getDeclaredConstructor().newInstance();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 初始化插件的配置</span></span><br><span class="line"></span><br><span class="line">            interceptorInstance.setProperties(properties);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将Interceptor对象添加到Configuration的插件链中保存，等待后续使用</span></span><br><span class="line"></span><br><span class="line">            configuration.addInterceptor(interceptorInstance);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-处理-lt-objectFactory-gt-标签"><a href="#5-处理-lt-objectFactory-gt-标签" class="headerlink" title="5. 处理&lt;objectFactory&gt;标签"></a>5. 处理<code>&lt;objectFactory&gt;</code>标签</h4><p>在前面中我们提到过，MyBatis 支持自定义 ObjectFactory 实现类和 ObjectWrapperFactory。XMLConfigBuilder 中的 objectFactoryElement() 方法就实现了加载自定义 ObjectFactory 实现类的功能，其核心逻辑就是解析 <code>&lt;objectFactory&gt;</code> 标签中配置的自定义 ObjectFactory 实现类，并完成相关的实例化操作，相关的代码实现如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">objectFactoryElement</span><span class="params">(XNode context)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (context != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取&lt;objectFactory&gt;标签的type属性</span></span><br><span class="line"></span><br><span class="line">    String type = context.getStringAttribute(<span class="string">&quot;type&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据type属性值，初始化自定义的ObjectFactory实现</span></span><br><span class="line"></span><br><span class="line">    ObjectFactory factory = (ObjectFactory) resolveClass(type).getDeclaredConstructor().newInstance();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化ObjectFactory对象的配置</span></span><br><span class="line"></span><br><span class="line">    Properties properties = context.getChildrenAsProperties();</span><br><span class="line"></span><br><span class="line">    factory.setProperties(properties);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将ObjectFactory对象记录到Configuration这个全局配置对象中</span></span><br><span class="line"></span><br><span class="line">    configuration.setObjectFactory(factory);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除了 <code>&lt;objectFactory&gt;</code> 标签之外，我们还可以通过 <code>&lt;objectWrapperFactory&gt;</code> 标签和 <code>&lt;reflectorFactory&gt;</code> 标签配置自定义的 ObjectWrapperFactory 实现类和 ReflectorFactory 实现类，这两个标签的解析分别对应 objectWrapperFactoryElement() 方法和 reflectorFactoryElement() 方法，两者实现与 objectFactoryElement() 方法实现类似，这里就不再展示，你若感兴趣的话可以参考<a target="_blank" rel="noopener" href="https://github.com/xxxlxy2008/mybatis">源码</a>进行学习。</p>
<h4 id="6-处理-lt-environments-gt-标签"><a href="#6-处理-lt-environments-gt-标签" class="headerlink" title="6. 处理&lt;environments&gt;标签"></a>6. 处理<code>&lt;environments&gt;</code>标签</h4><p>在 MyBatis 中，我们可以通过 <code>&lt;environment&gt;</code> 标签为不同的环境添加不同的配置，例如，线上环境、预上线环境、测试环境等，<strong>每个 <code>&lt;environment&gt;</code> 标签只会对应一种特定的环境配置</strong>。</p>
<p>environmentsElement() 方法中实现了 XMLConfigBuilder 处理 <code>&lt;environments&gt;</code> 标签的核心逻辑，它会根据 XMLConfigBuilder.environment 字段值，拿到正确的 <code>&lt;environment&gt;</code> 标签，然后解析这个环境中使用的 TransactionFactory、DataSource 等核心对象，也就知道了 MyBatis 要请求哪个数据库、如何管理事务等信息。</p>
<p>下面是 environmentsElement() 方法的核心逻辑：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">environmentsElement</span><span class="params">(XNode context)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (context != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (environment == <span class="keyword">null</span>) &#123; <span class="comment">// 未指定使用的环境id，默认获取default值 </span></span><br><span class="line"></span><br><span class="line">            environment = context.getStringAttribute(<span class="string">&quot;default&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取&lt;environment&gt;标签下的所有配置</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (XNode child : context.getChildren()) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取环境id</span></span><br><span class="line"></span><br><span class="line">            String id = child.getStringAttribute(<span class="string">&quot;id&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (isSpecifiedEnvironment(id)) &#123; </span><br><span class="line"></span><br><span class="line">                <span class="comment">// 获取&lt;transactionManager&gt;、&lt;dataSource&gt;等标签，并进行解析，其中会根据配置信息初始化相应的TransactionFactory对象和DataSource对象</span></span><br><span class="line"></span><br><span class="line">                TransactionFactory txFactory = transactionManagerElement(child.evalNode(<span class="string">&quot;transactionManager&quot;</span>));</span><br><span class="line"></span><br><span class="line">                DataSourceFactory dsFactory = dataSourceElement(child.evalNode(<span class="string">&quot;dataSource&quot;</span>));</span><br><span class="line"></span><br><span class="line">                DataSource dataSource = dsFactory.getDataSource();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 创建Environment对象，并关联创建好的TransactionFactory和DataSource</span></span><br><span class="line"></span><br><span class="line">                Environment.Builder environmentBuilder = <span class="keyword">new</span> Environment.Builder(id)</span><br><span class="line"></span><br><span class="line">                        .transactionFactory(txFactory)</span><br><span class="line"></span><br><span class="line">                        .dataSource(dataSource);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 将Environment对象记录到Configuration中，等待后续使用</span></span><br><span class="line"></span><br><span class="line">                configuration.setEnvironment(environmentBuilder.build());</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="7-处理-lt-databaseIdProvider-gt-标签"><a href="#7-处理-lt-databaseIdProvider-gt-标签" class="headerlink" title="7. 处理&lt;databaseIdProvider&gt;标签"></a>7. 处理<code>&lt;databaseIdProvider&gt;</code>标签</h4><p>通过前面课时的介绍可知，在 MyBatis 中编写的都是原生的 SQL 语句，而很多数据库产品都会有一些 SQL 方言，这些方言与标准 SQL 不兼容。</p>
<p>在 mybatis-config.xml 配置文件中，我们可以通过 <code>&lt;databaseIdProvider&gt;</code> 标签定义需要支持的全部数据库的 DatabaseId，在后续编写 Mapper 映射配置文件的时候，就可以为同一个业务场景定义不同的 SQL 语句（带有不同的 DataSourceId），来支持不同的数据库，这里就是靠 DatabaseId 来确定哪个 SQL 语句支持哪个数据库的。</p>
<p>databaseIdProviderElement() 方法是 XMLConfigBuilder 处理 <code>&lt;databaseIdProvider&gt;</code> 标签的地方，其中的<strong>核心就是获取 DatabaseId 值</strong>，具体实现如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">databaseIdProviderElement</span><span class="params">(XNode context)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    DatabaseIdProvider databaseIdProvider = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (context != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取type属性值</span></span><br><span class="line"></span><br><span class="line">        String type = context.getStringAttribute(<span class="string">&quot;type&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;VENDOR&quot;</span>.equals(type)) &#123; <span class="comment">// 兼容操作</span></span><br><span class="line"></span><br><span class="line">            type = <span class="string">&quot;DB_VENDOR&quot;</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 初始化DatabaseIdProvider</span></span><br><span class="line"></span><br><span class="line">        Properties properties = context.getChildrenAsProperties();</span><br><span class="line"></span><br><span class="line">        databaseIdProvider = (DatabaseIdProvider) resolveClass(type).getDeclaredConstructor().newInstance();</span><br><span class="line"></span><br><span class="line">        databaseIdProvider.setProperties(properties);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Environment environment = configuration.getEnvironment();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (environment != <span class="keyword">null</span> &amp;&amp; databaseIdProvider != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过DataSource获取DatabaseId，并保存到Configuration中，等待后续使用</span></span><br><span class="line"></span><br><span class="line">        String databaseId = databaseIdProvider.getDatabaseId(environment.getDataSource());</span><br><span class="line"></span><br><span class="line">        configuration.setDatabaseId(databaseId);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，解析<code>&lt;databaseIdProvider&gt;</code> 标签之后会得到一个 DatabaseIdProvider 对象，其核心方法是 getDatabaseId() 方法，主要是根据前面解析得到的 DataSource 对象来生成 DatabaseId。DatabaseIdProvider 的继承关系如下图所示：</p>
<p><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202202021401891.png" alt="image-20220202140130840"></p>
<p>从继承关系图中可以看出，DefaultDatabaseIdProvider 是个空实现，而且已被标记为过时了，所以这里我们就重点来看 VendorDatabaseIdProvider 实现。</p>
<p>在 getDatabaseId() 方法中，VendorDatabaseIdProvider 首先会从 DataSource 中拿到数据库的名称，然后根据 <code>&lt;databaseIdProvider&gt; </code>标签配置和 DataSource 返回的数据库名称，确定最终的 DatabaseId 标识，具体实现如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getDatabaseId</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略边界检查和异常处理</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> getDatabaseName(dataSource);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getDatabaseName</span><span class="params">(DataSource dataSource)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从数据库连接中，获取数据库名称</span></span><br><span class="line"></span><br><span class="line">    String productName = getDatabaseProductName(dataSource);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.properties != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据&lt;databaseIdProvider&gt;标签配置，查找自定义数据库名称</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;Object, Object&gt; property : properties.entrySet()) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (productName.contains((String) property.getKey())) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> (String) property.getValue(); <span class="comment">// 返回配置的value</span></span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> productName;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="8-处理-lt-mappers-gt-标签"><a href="#8-处理-lt-mappers-gt-标签" class="headerlink" title="8. 处理&lt;mappers&gt;标签"></a>8. 处理<code>&lt;mappers&gt;</code>标签</h4><p>除了 mybatis-config.xml 这个全局配置文件之外，MyBatis 初始化的时候还会加载 <code>&lt;mappers&gt;</code> 标签下定义的 Mapper 映射文件。<code>&lt;mappers&gt;</code> 标签中会指定 Mapper.xml 映射文件的位置，通过解析 <code>&lt;mappers&gt; </code>标签，MyBatis 就能够知道去哪里加载这些 Mapper.xml 文件了。</p>
<p>mapperElement() 方法就是 XMLConfigBuilder 处理 <code>&lt;mappers&gt;</code> 标签的具体实现，其中会初始化 XMLMapperBuilder 对象来加载各个 Mapper.xml 映射文件。同时，还会扫描 Mapper 映射文件相应的 Mapper 接口，处理其中的注解并将 Mapper 接口注册到 MapperRegistry 中。</p>
<p>mapperElement() 方法的具体实现如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">mapperElement</span><span class="params">(XNode parent)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (XNode child : parent.getChildren()) &#123; <span class="comment">// 遍历每个子标签</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;package&quot;</span>.equals(child.getName())) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 如果指定了&lt;package&gt;子标签，则会扫描指定包内全部Java类型</span></span><br><span class="line"></span><br><span class="line">                String mapperPackage = child.getStringAttribute(<span class="string">&quot;name&quot;</span>);</span><br><span class="line"></span><br><span class="line">                configuration.addMappers(mapperPackage);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 解析&lt;mapper&gt;子标签，这里会获取resource、url、class三个属性，这三个属性互斥</span></span><br><span class="line"></span><br><span class="line">                String resource = child.getStringAttribute(<span class="string">&quot;resource&quot;</span>);</span><br><span class="line"></span><br><span class="line">                String url = child.getStringAttribute(<span class="string">&quot;url&quot;</span>);</span><br><span class="line"></span><br><span class="line">                String mapperClass = child.getStringAttribute(<span class="string">&quot;class&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 如果&lt;mapper&gt;子标签指定了resource或是url属性，都会创建XMLMapperBuilder对象，</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 然后使用这个XMLMapperBuilder实例解析指定的Mapper.xml配置文件</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (resource != <span class="keyword">null</span> &amp;&amp; url == <span class="keyword">null</span> &amp;&amp; mapperClass == <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    ErrorContext.instance().resource(resource);</span><br><span class="line"></span><br><span class="line">                    InputStream inputStream = Resources.getResourceAsStream(resource);</span><br><span class="line"></span><br><span class="line">                    XMLMapperBuilder mapperParser = <span class="keyword">new</span> XMLMapperBuilder(inputStream, configuration, resource, configuration.getSqlFragments());</span><br><span class="line"></span><br><span class="line">                    mapperParser.parse();</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resource == <span class="keyword">null</span> &amp;&amp; url != <span class="keyword">null</span> &amp;&amp; mapperClass == <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    ErrorContext.instance().resource(url);</span><br><span class="line"></span><br><span class="line">                    InputStream inputStream = Resources.getUrlAsStream(url);</span><br><span class="line"></span><br><span class="line">                    XMLMapperBuilder mapperParser = <span class="keyword">new</span> XMLMapperBuilder(inputStream, configuration, url, configuration.getSqlFragments());</span><br><span class="line"></span><br><span class="line">                    mapperParser.parse();</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resource == <span class="keyword">null</span> &amp;&amp; url == <span class="keyword">null</span> &amp;&amp; mapperClass != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 如果&lt;mapper&gt;子标签指定了class属性，则向MapperRegistry注册class属性指定的Mapper接口</span></span><br><span class="line"></span><br><span class="line">                    Class&lt;?&gt; mapperInterface = Resources.classForName(mapperClass);</span><br><span class="line"></span><br><span class="line">                    configuration.addMapper(mapperInterface);</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">&quot;A mapper element may only specify a url, resource or class, but not more than one.&quot;</span>);</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>这一讲我们重点介绍了 MyBatis 初始化过程中对 mybatis-config.xml 全局配置文件的解析，深入分析了 mybatis-config.xml 配置文件中所有标签的解析流程，让你进一步了解这些配置加载的原理。同时，我们还介绍了构造者模式这一经典设计模式，它是整个 MyBatis 初始化逻辑的基础思想。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">小肥龙吃大冰淇淋</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://pengdanhua.github.io/post/e83a8e86.html">https://pengdanhua.github.io/post/e83a8e86.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://pengdanhua.github.io" target="_blank">小肥龙吃大冰淇淋</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%BA%90%E7%A0%81/">源码</a><a class="post-meta__tags" href="/tags/MyBatis/">MyBatis</a></div><div class="post_share"><div class="social-share" data-image="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211108212035.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/mm_facetoface_collect_qrcode_1628169825807.png" target="_blank"><img class="post-qr-code-img" src="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/mm_facetoface_collect_qrcode_1628169825807.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/1628169797.jpg" target="_blank"><img class="post-qr-code-img" src="https://cdn.jsdelivr.net/gh/LVXUEYANGTiger/blog@main/1628169797.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/post/f121bfc7.html"><img class="prev-cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211004082055.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">MyBatis启动流程(下)</div></div></a></div><div class="next-post pull-right"><a href="/post/92521f4c.html"><img class="next-cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211108212120.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">MyBatis-缓存模块</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/post/d2457c0e.html" title="MyBatis基础"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211004082319.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-30</div><div class="title">MyBatis基础</div></div></a></div><div><a href="/post/2c85ae97.html" title="MyBatis反射工具箱"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211108212110.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-30</div><div class="title">MyBatis反射工具箱</div></div></a></div><div><a href="/post/11fe8b03.html" title="MyBatis源码环境搭建及整体架构"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211108212110.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-30</div><div class="title">MyBatis源码环境搭建及整体架构</div></div></a></div><div><a href="/post/dd9fe9e6.html" title="MyBatis设计思维"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211108212050.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-30</div><div class="title">MyBatis设计思维</div></div></a></div><div><a href="/post/4eac7e22.html" title="MyBatis日志框架"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211004082041.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-30</div><div class="title">MyBatis日志框架</div></div></a></div><div><a href="/post/3c4593b6.html" title="MyBatis类型转换"><img class="cover" src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/20211108212120.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-30</div><div class="title">MyBatis类型转换</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E8%80%85%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.</span> <span class="toc-text">构造者模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mybatis-config-xml-%E8%A7%A3%E6%9E%90%E5%85%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">mybatis-config.xml 解析全流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%A4%84%E7%90%86-lt-properties-gt-%E6%A0%87%E7%AD%BE"><span class="toc-number">2.1.</span> <span class="toc-text">1. 处理&lt;properties&gt;标签</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%A4%84%E7%90%86-lt-settings-gt-%E6%A0%87%E7%AD%BE"><span class="toc-number">2.2.</span> <span class="toc-text">2. 处理&lt;settings&gt;标签</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%A4%84%E7%90%86-lt-typeAliases-gt-%E5%92%8C-lt-typeHandlers-gt-%E6%A0%87%E7%AD%BE"><span class="toc-number">2.3.</span> <span class="toc-text">3. 处理&lt;typeAliases&gt;和&lt;typeHandlers&gt;标签</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E5%A4%84%E7%90%86-lt-plugins-gt-%E6%A0%87%E7%AD%BE"><span class="toc-number">2.4.</span> <span class="toc-text">4. 处理&lt;plugins&gt;标签</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E5%A4%84%E7%90%86-lt-objectFactory-gt-%E6%A0%87%E7%AD%BE"><span class="toc-number">2.5.</span> <span class="toc-text">5. 处理&lt;objectFactory&gt;标签</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-%E5%A4%84%E7%90%86-lt-environments-gt-%E6%A0%87%E7%AD%BE"><span class="toc-number">2.6.</span> <span class="toc-text">6. 处理&lt;environments&gt;标签</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-%E5%A4%84%E7%90%86-lt-databaseIdProvider-gt-%E6%A0%87%E7%AD%BE"><span class="toc-number">2.7.</span> <span class="toc-text">7. 处理&lt;databaseIdProvider&gt;标签</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-%E5%A4%84%E7%90%86-lt-mappers-gt-%E6%A0%87%E7%AD%BE"><span class="toc-number">2.8.</span> <span class="toc-text">8. 处理&lt;mappers&gt;标签</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">3.</span> <span class="toc-text">总结</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By 小肥龙吃大冰淇淋</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="framework-info"><img src="https://note-1259153703.cos.ap-nanjing.myqcloud.com/images/202301132049386.png"/><span> </span><a target="_blank" rel="noopener" href="http://beian.miit.gov.cn/">晋ICP备2022012091号-1</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>(()=>{
  const $countDom = document.getElementById('twikoo-count')
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'pinglun-9gh2lmcnd8587831',
      region: ''
    }, null))
  }

  const getCount = () => {
    twikoo.getCommentsCount({
      envId: 'pinglun-9gh2lmcnd8587831',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      $countDom.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const loadTwikoo = (bool = false) => {
    if (typeof twikoo === 'object') {
      init()
      bool && $countDom && setTimeout(getCount,0)
    } else {
      getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(()=> {
        init()
        bool && $countDom && setTimeout(getCount,0)
      })
    }
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo(true)
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script defer src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/hexo-theme-volantis@latest/source/js/issues.min.js"></script><script src="//code.tidio.co/smwivpnwumemac2wohardi3d3gpud1ag.js" async="async"></script><script>function onTidioChatApiReady() {
  window.tidioChatApi.hide();
  window.tidioChatApi.on("close", function() {
    window.tidioChatApi.hide();
  });
}
if (window.tidioChatApi) {
  window.tidioChatApi.on("ready", onTidioChatApiReady);
} else {
  document.addEventListener("tidioChat-ready", onTidioChatApiReady);
}

var chatBtnFn = () => {
  document.getElementById("chat_btn").addEventListener("click", function(){
    window.tidioChatApi.show();
    window.tidioChatApi.open();
  });
}
chatBtnFn()
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>